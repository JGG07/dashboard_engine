<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="/path/to/styles.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Tratos</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        body{
            background-color: #323339;
        }
        /* Estilos para el contenedor de los KPI */
        .kpi-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 12px;
        }
        .kpi-box {
            width: 200px;
            height: 100px;
            background-color: #A1725A; /* Fondo del cuadrado */
            color: #ffffff; /* Color del texto */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px; /* Bordes redondeados */
            box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1); /* Sombra */
            font-family: 'JetBrains Mono'; /* Fuente */
            margin: 1px;
            padding: 1px;
            text-align: center;
        }
        .kpi-box .kpi-label {
            font-size: 20px;
            font-weight: 500;
            color: #FFFFFF; /* Color del texto */
            border-radius: 5px; /* Bordes redondeados */
        }
        .kpi-box .kpi-value {
            font-size: 20px; /* Tamaño de la fuente del valor */
            font-weight: 700;
        }
        /* Estilo de la gráfica */
        .chart-container {
            position: relative;
            width: 100%; /* O puedes ajustar a un ancho fijo, como '1200px' */
            height: 1000px; /* Aumenta la altura según sea necesario */
            margin-top: 1px; /* Ajusta el margen superior si es necesario */
            border-radius: 4px;
        }
        /* Estilos para la tabla de fuentes */
        .source-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: 'JetBrains Mono';
        }
        .source-table th, .source-table td {
            border: 1px solid #A1725A;
            padding: 8px;
            text-align: center;
        }
        .source-table th {
            background-color: #A1725A; /* Fondo de la cabecera */
            color: white; /* Color del texto de la cabecera */
            text-align: center;
        }
        .source-table td {
            text-align: center;
            color: #FFFFFF
        }
        .source-table tr:nth-child(even) {
            background-color: #1F1D1C; /* Color para las filas pares */
        }
        .source-table tr:nth-child(odd) {
            background-color: #333333; /* Color para las filas impares */
        }
        .source-table tr.highlight {
            background-color: #FF6347; /* Color para filas resaltadas */
        }
        /* Estilos para la tabla de fuentes */
        .source-table-reason, #pie-container {
            width: 50%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: 'JetBrains Mono';
        }
        .source-table-reason th, .source-table-reason td {
            border: 1px solid #A1725A;
            padding: 8px;
            text-align: center;
        }
        .source-table-reason th {
            background-color: #A1725A; /* Fondo de la cabecera */
            color: white; /* Color del texto de la cabecera */
            text-align: center;
        }
        .source-table-reason td {
            text-align: center;
            color: #FFFFFF
        }
        .source-table-reason tr:nth-child(even) {
            background-color: #1F1D1C; /* Color para las filas pares */
        }
        .source-table-reason tr:nth-child(odd) {
            background-color: #333333; /* Color para las filas impares */
        }
        .source-table-reason tr.highlight {
            background-color: #FF6347; /* Color para filas resaltadas */
        }
        .table-chart-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        #pie-container {
            background-color: #1F1D1C;
            color: #ffffff;
            height: 900px; /* Ajusta la altura según sea necesario */
        }
        .filter-container {
            margin: 20px;
            padding: 10px;
            background-color: #2C2C2C;
            border-radius: 5px;
            color: #FFFFFF;
        }

        .filter-container label {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .filter-container select {
            padding: 5px;
            font-size: 1em;
            border: 1px solid #CCCCCC;
            border-radius: 4px;
            background-color: #333333;
            color: #FFFFFF;
        }

        .filter-container select option {
            background-color: #333333;
            color: #FFFFFF;
        }

        .filter-container select option:hover {
            background-color: #555555;
        }
    </style>
</head>
<body>
<!-- Cuadro de selección para filtrar por fuente -->
<div class="filter-container">
    <label for="source-filter">Filtrar por Fuente:</label>
    <select id="source-filter">
        <option value="all">Todas</option>
        <option value="cartera propia" id="67">Cartera Propia</option>
        <option value="desconocido">Desconocido</option>
        <option value="espectacular">Espectacular</option>
        <option value="evento">Evento</option>
        <option value="facebook">Facebook</option>
        <option value="instagram">Instagram</option>
        <option value="linkedin">LinkedIn</option>
        <option value="referido">Referido</option>
        <option value="sitio web">Sitio Web</option>
        <option value="tapial obra">Tapial Obra</option>
        <option value="tapial showroom">Tapial ShowRoom</option>
        <option value="tiktok">TikTok</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="x">X</option>
        <option value="youtube">YouTube</option>
    </select>
</div>

<!-- Contenedor para los cuadros KPI -->
<div class="kpi-container" >
    <!-- Cuadro para mostrar el total de tratos -->
    <div class="kpi-box">
        <div class="kpi-label">Total Tratos</div>
        <div class="kpi-value" th:text="${totalDeals}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de Interesados -->
    <div class="kpi-box">
        <div class="kpi-label">Interesados</div>
        <div class="kpi-value" th:text="${totalInteresados}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de Contactados -->
    <div class="kpi-box">
        <div class="kpi-label">Contactados</div>
        <div class="kpi-value" th:text="${totalContactado}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de citas -->
    <div class="kpi-box">
        <div class="kpi-label">Citas</div>
        <div class="kpi-value" th:text="${totalCitas}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de visitas -->
    <div class="kpi-box">
        <div class="kpi-label">Visitas</div>
        <div class="kpi-value" th:text="${totalVisitas}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de negociaciones -->
    <div class="kpi-box">
        <div class="kpi-label">Negociaciones</div>
        <div class="kpi-value" th:text="${totalNegociaciones}">0</div>
    </div>
    <!-- Cuadro para mostrar el total de apartados -->
    <div class="kpi-box">
        <div class="kpi-label">Apartados</div>
        <div class="kpi-value" th:text="${totalApartados}">0</div>
    </div>
</div>

<!-- Contenedor para la gráfica -->
<div id="chart-container" class="chart-container"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let chart;
    document.addEventListener('DOMContentLoaded', function () {
        chart = Highcharts.chart('chart-container', {
            chart: {
                backgroundColor: '#1F1D1C',
                type: 'line'
            },
            title: {
                text: '',
                style: {
                    color: '#FFFFFF'
                }
            },
            xAxis: {
                categories: /*[[${dealsDates}]]*/,
                labels: {
                    style: {
                        color: '#FFFFFF'
                    }
                }
            },
            yAxis: {
                title: {
                    text: 'Número de Tratos',
                    style: {
                        color: '#FFFFFF'
                    }
                },
                labels: {
                    style: {
                        color: '#FFFFFF'
                    }
                }
            },
            legend: {
                itemStyle: {
                    color: '#FFFFFF'
                }
            },
            plotOptions: {
                line: {
                    dataLabels: {
                        enabled: true,
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    enableMouseTracking: true
                }
            },
            series: [{
                name: 'Tratos Totales',
                data: /*[[${dealsCounts}]]*/
            },{
                name: 'Contactados',
                data: /*[[${contactados}]]*/
            },{
                name: 'Interesados',
                data: /*[[${interesados}]]*/
            },{
                name: 'Citas',
                data: /*[[${citas}]]*/
            },{
                name: 'Visitas',
                data: /*[[${visitas}]]*/
            },{
                name: 'Negociaciones',
                data: /*[[${negociaciones}]]*/
            },{
                name: 'Apartados',
                data: /*[[${apartados}]]*/
            }]
        });
        const sourceFilter = document.getElementById('source-filter');
        const tableRows = document.querySelectorAll('.source-table tbody tr');
        const allDealsData = /*[[${allDealsData}]]*/ [];

        sourceFilter.addEventListener('change', function () {
            const selectedSource = this.value;

            tableRows.forEach(row => {
                const source = row.querySelector('td').innerText.toLowerCase();
                if (selectedSource === 'all' || source === selectedSource) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Filtrar datos para la gráfica
            const filteredData = allDealsData.filter(deal => selectedSource === 'all' || deal.source === selectedSource);

            const filteredDates = filteredData.map(deal => deal.date);
            const filteredTotalDeals = filteredData.map(deal => deal.totalDeals);
            const filteredContactados = filteredData.map(deal => deal.contactados);
            const filteredInteresados = filteredData.map(deal => deal.interesados);
            const filteredCitas = filteredData.map(deal => deal.citas);
            const filteredVisitas = filteredData.map(deal => deal.visitas);
            const filteredNegociaciones = filteredData.map(deal => deal.negociaciones);
            const filteredApartados = filteredData.map(deal => deal.apartados);

            // Actualizar la gráfica con los datos filtrados
            chart.xAxis[0].setCategories(filteredDates);
            chart.series[0].setData(filteredTotalDeals);
            chart.series[1].setData(filteredContactados);
            chart.series[2].setData(filteredInteresados);
            chart.series[3].setData(filteredCitas);
            chart.series[4].setData(filteredVisitas);
            chart.series[5].setData(filteredNegociaciones);
            chart.series[6].setData(filteredApartados);
        });
    });
    /*]]>*/
</script>

<!-- Tabla para mostrar datos por fuente -->
<table class="source-table">
    <thead>
    <tr>
        <th>Fuente</th>
        <th>Tratos Totales</th>
        <th>Interesados</th>
        <th>Contactados</th>
        <th>Citas</th>
        <th>Visitas</th>
        <th>Negociaciones</th>
        <th>Apartados</th>
        <th></th> <th>Abiertos</th>
        <th>Perdidos</th>
        <th>Ganados</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="entry : ${dealsBySource}">
        <td th:text="${entry.key}">Fuente</td>
        <td th:text="${totalDealsBySource[entry.key] != null ? totalDealsBySource[entry.key] : 0}"
            data-value="${totalDealsBySource[entry.key] != null ? totalDealsBySource[entry.key] : 0}">0
        </td>
        <td th:text="${entry.value['Interesado'] != null ? entry.value['Interesado'] : 0}"
            data-value="${entry.value['Interesado'] != null ? entry.value['Interesado'] : 0}">0
        </td>
        <td th:text="${entry.value['Contactado'] != null ? entry.value['Contactado'] : 0}"
            data-value="${entry.value['Contactado'] != null ? entry.value['Contactado'] : 0}">0
        </td>
        <td th:text="${entry.value['Cita'] != null ? entry.value['Cita'] : 0}"
            data-value="${entry.value['Cita'] != null ? entry.value['Cita'] : 0}">0
        </td>
        <td th:text="${entry.value['Visita'] != null ? entry.value['Visita'] : 0}"
            data-value="${entry.value['Visita'] != null ? entry.value['Visita'] : 0}">0
        </td>
        <td th:text="${entry.value['Negociación'] != null ? entry.value['Negociación'] : 0}"
            data-value="${entry.value['Negociación'] != null ? entry.value['Negociación'] : 0}">0
        </td>
        <td th:text="${entry.value['Apartado'] != null ? entry.value['Apartado'] : 0}"
            data-value="${entry.value['Apartado'] != null ? entry.value['Apartado'] : 0}">0
        </td>
        <td></td>
        <td th:text="${openDealsBySource[entry.key] != null ? openDealsBySource[entry.key] : 0}"
            data-value="${openDealsBySource[entry.key] != null ? openDealsBySource[entry.key] : 0}">0
        </td>
        <td th:text="${lostDealsBySource[entry.key] != null ? lostDealsBySource[entry.key] : 0}"
            data-value="${lostDealsBySource[entry.key] != null ? lostDealsBySource[entry.key] : 0}">0
        </td>
        <td th:text="${wonDealsBySource[entry.key] != null ? wonDealsBySource[entry.key] : 0}"
            data-value="${wonDealsBySource[entry.key] != null ? wonDealsBySource[entry.key] : 0}">0
        </td>
    </tr>
    </tbody>

    <tfoot>
    <tr>
        <th>Total</th>
        <td th:text="${totalDeals}">0</td>
        <td th:text="${totalInteresados}">0</td>
        <td th:text="${totalContactado}">0</td>
        <td th:text="${totalCitas}">0</td>
        <td th:text="${totalVisitas}">0</td>
        <td th:text="${totalNegociaciones}">0</td>
        <td th:text="${totalApartados}">0</td>
        <td></td>
        <td th:text="${totalOpenDeals}">0</td>
        <td th:text="${totalLostDeals}">0</td>
        <td th:text="${totalWonDeals}">0</td>
    </tr>
    </tfoot>
</table>

<script>
    // Actualización dinámica de la tabla
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.source-table tbody');
        const rows = table.querySelectorAll('tr');

        // Definir los índices de las columnas para los datos
        const columns = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        const maxValues = {};

        // Encontrar los valores máximos para cada columna
        columns.forEach(colIndex => {
            maxValues[colIndex] = 0;
            rows.forEach(row => {
                const cell = row.cells[colIndex];
                if (cell) {
                    const value = parseInt(cell.dataset.value) || 0;
                    if (value > maxValues[colIndex]) {
                        maxValues[colIndex] = value;
                    }
                }
            });
        });

        // Aplicar colores basados en la intensidad
        rows.forEach(row => {
            columns.forEach(colIndex => {
                const cell = row.cells[colIndex];
                if (cell) {
                    const value = parseInt(cell.dataset.value) || 0;
                    const maxValue = maxValues[colIndex];
                    const intensity = maxValue ? value / maxValue : 0;
                    const color = `rgba(0, 0, 255, ${intensity})`; // Color azul con opacidad variable
                    cell.style.backgroundColor = color;
                }
            });
        });
    });
</script>

<!-- Contenedor para la tabla y gráfica -->
<div class="table-chart-container">
    <!-- Tabla de razones de pérdida -->
    <table class="source-table-reason">
        <thead>
        <tr>
            <th>Razón de Pérdida</th>
            <th>Total</th>
            <th>Porcentaje</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="entry : ${sortedLostReasons}">
            <td th:text="${entry.key}"></td>
            <td th:text="${entry.value}"></td>
            <td th:text="${reasonsWithPercentages[entry.key]}"></td>
        </tr>
        <tr class="total">
            <td><strong>Total</strong></td>
            <td th:text="${totalLostReasons}"></td>
            <td>100%</td>
        </tr>
        </tbody>
    </table>

    <!-- Contenedor para la gráfica de pastel -->
    <div id="pie-container"></div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // Variables Thymeleaf convertidas en formato JavaScript
        var sortedLostReasons = /*[[${sortedLostReasons}]]*/ {};
        var reasonsWithPercentages = /*[[${reasonsWithPercentages}]]*/ {};
        var totalLostReasons = /*[[${totalLostReasons}]]*/ 0;

        // Preparar datos para la gráfica de pastel
        var pieData = Object.keys(sortedLostReasons).map(function(reason) {
            return {
                name: reason,
                y: sortedLostReasons[reason]
            };
        });

        Highcharts.chart('pie-container', {
            chart: {
                type: 'pie',
                backgroundColor: '#1F1D1C'
            },
            title: {
                text:'',
                style: {
                    color: '#FFFFFF' // Color del título
                }
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>',
                style: {
                    color: '#FFFFFF' // Color del texto del tooltip
                }
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                        style: {
                            color: '#FFFFFF' // Color del texto de los data labels
                        }
                    }
                }
            },
            series: [{
                name: 'Razón de Pérdida',
                colorByPoint: true,
                data: pieData,
                colors: ['#FF6347', '#4682B4', '#32CD32', '#FFD700', '#FF69B4', '#8A2BE2', '#5F9EDC', '#D2691E', '#FF4500', '#6A5ACD'] // Colores personalizados para cada segmento
            }]
        });
    });
    /*]]>*/
</script>
</body>
</html>
